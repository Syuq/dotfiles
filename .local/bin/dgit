#!/bin/bash

error() { echo -e "$1" && exit; }

flag="${1}"
dotfilesDir="${HOME}/user/works/repos/dotfiles/"
nvimDir="${HOME}/.config/nvim/"

config() {
    case ${flag} in
        "-h")
            cd ${HOME}
            git --git-dir="${dotfilesDir}" --work-tree=${HOME} "$@"
            ;;
        "-v")
            cd ${nvimDir}
            git --git-dir="${nvimDir}/.git" --work-tree=${nvimDir} "$@"
            ;;
        *)
            cd ${repoDir}
            git --git-dir="${repoDir}/.git" --work-tree="${repoDir}" "$@"
            ;;
    esac
}

git_clone() {
    local choice="`printf "Clipboard\nEnter user, repository (github only)" |
        rofi -dmenu -p "Git" 2> /dev/null`"
    case "${choice}" in
        "Clipboard")
            git clone "$(xclip -o)"
            ;;
        "Enter user, repository (github only)")
            local github_user="`printf "" | rofi -dmenu -l 0 -p "User:" 2> /dev/null`"
            local repos=(`curl -Ls "https://api.github.com/users/${github_user}/repos?per_page=100" -m 5 |
                grep -oP 'git@.*(?=.git)' | cut -d '/' -f 2`)
            [ ${#repos[@]} -eq 0 ] &&
                error "Cannot find any repository of ${github_user}!\nCheck username or try again later."
            local chosen_repo=`for repo in "${repos[@]}"; do echo "${repo}"; done |
                rofi -dmenu -p "Repository (${#repos[@]}):" -matching fuzzy 2> /dev/null`
            [ "${chosen_repo}" != "" ] &&
                git clone "https://github.com/${github_user}/${chosen_repo}.git"
            ;;
        *)
            error "Something went wrong!"
            ;;
    esac
    exit 0
}

while :; do
    repoDir="`git rev-parse --show-toplevel 2> /dev/null`"
    [ "${repoDir}" = "" ] && [ "${1}" = "" ] && error "Cannot detect .git folder!"
    [ "${1}" = "-c" ] && git_clone

    modifiedFiles=(`config ls-files -m`)
    files_size=${#modifiedFiles[@]}
    files=("`for file in "${modifiedFiles[@]}"; do echo "${file}" |
        sed -e 's/^/!: /'; done`")

    if [[ "$flag" != "-h" ]]; then
        untrackedFiles=(`config ls-files --others --exclude-standard`)
        tmp=${#untrackedFiles[@]}
        files_size=$((files_size+tmp))
        files=("$files" "`for file in "${untrackedFiles[@]}"; do echo "$file" |
            sed -e 's/^/?: /'; done`")
    fi

    choice="`printf "add\npush\nquit" | rofi -dmenu -p "Git" 2> /dev/null`"

    case "$choice" in
        "add")
            chosenFiles=(`for file in "${files[@]}"; do
                [ "$file" = "" ] && continue
                if [ ${files_size} -eq 1 ]; then
                    printf "${file}"
                else
                    printf "+all\n${file}"
                fi
            done | rofi -dmenu -p "Add" -matching fuzzy 2> /dev/null | cut -d' ' -f2`)

            if [ ${#chosenFiles[@]} -ne 0 ]; then
                if [ "$chosenFiles" = "+all" ]; then
                    config add "$repoDir/."
                else
                    config add "${chosenFiles[@]}"
                [ $? -ne 0 ] && echo "No such file or directory!" && continue
                fi

                commitMsg="`printf "" | rofi -dmenu -l 0 -p "Commit" 2> /dev/null`"
                if [ ${#chosenFiles[@]} -eq 1 ]; then
                    [[ "$commitMsg" = \!* ]] && commitMsg="${commitMsg:1}" ||
                        commitMsg="${chosenFiles[0]##*/}: $commitMsg"
                fi

                config commit -m "$commitMsg"
            fi
            ;;
        "push")
            config push
            ;;
        "quit")
            break
            ;;
    esac
done

exit 0
